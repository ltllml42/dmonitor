/*
 * Nestable jQuery Plugin - Copyright (c) 2012 David Bushell - http://dbushell.com/
 * Dual-licensed under the BSD or MIT licenses
 */
(function(A,H,F,C){var G="ontouchstart" in F.documentElement;var B=(function(){var N=F.createElement("div"),M=F.documentElement;if(!("pointerEvents" in N.style)){return false}N.style.pointerEvents="auto";N.style.pointerEvents="x";M.appendChild(N);var L=H.getComputedStyle&&H.getComputedStyle(N,"").pointerEvents==="auto";M.removeChild(N);return !!L})();var D="mousedown touchstart MSPointerDown pointerdown",J="mousemove touchmove MSPointerMove pointermove",E="mouseup touchend touchcancel MSPointerUp MSPointerCancel pointerup pointercancel";var I={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};function K(L,M){this.w=A(H);this.el=A(L);this.options=A.extend({},I,M);this.init()}K.prototype={init:function(){var L=this;L.reset();L.el.data("nestable-group",this.options.group);L.placeEl=A('<div class="'+L.options.placeClass+'"/>');A.each(this.el.find(L.options.itemNodeName),function(Q,P){L.setParent(A(P))});L.el.on("click","button",function(S){if(L.dragEl||("button" in S&&S.button!==0)){return}var R=A(S.currentTarget),Q=R.data("action"),P=R.parent(L.options.itemNodeName);if(Q==="collapse"){L.collapseItem(P)}if(Q==="expand"){L.expandItem(P)}});var N=function(P){P=P.originalEvent;var Q=A(P.target);if(!Q.hasClass(L.options.handleClass)){if(Q.closest("."+L.options.noDragClass).length){return}Q=Q.closest("."+L.options.handleClass)}if(!Q.length||L.dragEl||("button" in P&&P.button!==0)||("touches" in P&&P.touches.length!==1)){return}P.preventDefault();L.dragStart("touches" in P?P.touches[0]:P)};var M=function(P){if(L.dragEl){P=P.originalEvent;P.preventDefault();L.dragMove("touches" in P?P.touches[0]:P)}};var O=function(P){if(L.dragEl){P=P.originalEvent;P.preventDefault();L.dragStop("touches" in P?P.touches[0]:P)}};L.el.on(D,N);L.w.on(J,M);L.w.on(E,O)},serialize:function(){var N,M=0,L=this;step=function(O,P){var R=[],Q=O.children(L.options.itemNodeName);Q.each(function(){var S=A(this),T=A.extend({},S.data()),U=S.children(L.options.listNodeName);if(U.length){T.children=step(U,P+1)}R.push(T)});return R};N=step(L.el.find(L.options.listNodeName).first(),M);return N},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=false;this.pointEl=null},expandItem:function(L){L.removeClass(this.options.collapsedClass);L.children('[data-action="expand"]').hide();L.children('[data-action="collapse"]').show();L.children(this.options.listNodeName).show()},collapseItem:function(L){var M=L.children(this.options.listNodeName);if(M.length){L.addClass(this.options.collapsedClass);L.children('[data-action="collapse"]').hide();L.children('[data-action="expand"]').show();L.children(this.options.listNodeName).hide()}},expandAll:function(){var L=this;L.el.find(L.options.itemNodeName).each(function(){L.expandItem(A(this))})},collapseAll:function(){var L=this;L.el.find(L.options.itemNodeName).each(function(){L.collapseItem(A(this))})},setParent:function(L){if(L.children(this.options.listNodeName).length){L.prepend(A(this.options.expandBtnHTML));L.prepend(A(this.options.collapseBtnHTML))}L.children('[data-action="expand"]').hide()},unsetParent:function(L){L.removeClass(this.options.collapsedClass);L.children("[data-action]").remove();L.children(this.options.listNodeName).remove()},dragStart:function(P){var Q=this.mouse,M=A(P.target),L=M.closest(this.options.itemNodeName);this.placeEl.css("height",L.height());Q.offsetX=P.offsetX!==C?P.offsetX:P.pageX-M.offset().left;Q.offsetY=P.offsetY!==C?P.offsetY:P.pageY-M.offset().top;Q.startX=Q.lastX=P.pageX;Q.startY=Q.lastY=P.pageY;this.dragRootEl=this.el;this.dragEl=A(F.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass);this.dragEl.css("width",L.width());L.after(this.placeEl);L[0].parentNode.removeChild(L[0]);L.appendTo(this.dragEl);A(F.body).append(this.dragEl);this.dragEl.css({"left":P.pageX-Q.offsetX,"top":P.pageY-Q.offsetY});var O,N,R=this.dragEl.find(this.options.itemNodeName);for(O=0;O<R.length;O++){N=A(R[O]).parents(this.options.listNodeName).length;if(N>this.dragDepth){this.dragDepth=N}}},dragStop:function(M){var L=this.dragEl.children(this.options.itemNodeName).first();L[0].parentNode.removeChild(L[0]);this.placeEl.replaceWith(L);this.dragEl.remove();this.el.trigger("change");if(this.hasNewRoot){this.dragRootEl.trigger("change")}this.reset()},dragMove:function(S){var T,V,O,M,N,R=this.options,P=this.mouse;this.dragEl.css({"left":S.pageX-P.offsetX,"top":S.pageY-P.offsetY});P.lastX=P.nowX;P.lastY=P.nowY;P.nowX=S.pageX;P.nowY=S.pageY;P.distX=P.nowX-P.lastX;P.distY=P.nowY-P.lastY;P.lastDirX=P.dirX;P.lastDirY=P.dirY;P.dirX=P.distX===0?0:P.distX>0?1:-1;P.dirY=P.distY===0?0:P.distY>0?1:-1;var U=Math.abs(P.distX)>Math.abs(P.distY)?1:0;if(!P.moving){P.dirAx=U;P.moving=true;return}if(P.dirAx!==U){P.distAxX=0;P.distAxY=0}else{P.distAxX+=Math.abs(P.distX);if(P.dirX!==0&&P.dirX!==P.lastDirX){P.distAxX=0}P.distAxY+=Math.abs(P.distY);if(P.dirY!==0&&P.dirY!==P.lastDirY){P.distAxY=0}}P.dirAx=U;if(P.dirAx&&P.distAxX>=R.threshold){P.distAxX=0;O=this.placeEl.prev(R.itemNodeName);if(P.distX>0&&O.length&&!O.hasClass(R.collapsedClass)){T=O.find(R.listNodeName).last();N=this.placeEl.parents(R.listNodeName).length;if(N+this.dragDepth<=R.maxDepth){if(!T.length){T=A("<"+R.listNodeName+"/>").addClass(R.listClass);T.append(this.placeEl);O.append(T);this.setParent(O)}else{T=O.children(R.listNodeName).last();T.append(this.placeEl)}}}if(P.distX<0){M=this.placeEl.next(R.itemNodeName);if(!M.length){V=this.placeEl.parent();this.placeEl.closest(R.itemNodeName).after(this.placeEl);if(!V.children().length){this.unsetParent(V.parent())}}}}var L=false;if(!B){this.dragEl[0].style.visibility="hidden"}this.pointEl=A(F.elementFromPoint(S.pageX-F.body.scrollLeft,S.pageY-(H.pageYOffset||F.documentElement.scrollTop)));if(!B){this.dragEl[0].style.visibility="visible"}if(this.pointEl.hasClass(R.handleClass)){this.pointEl=this.pointEl.parent(R.itemNodeName)}if(this.pointEl.hasClass(R.emptyClass)){L=true}else{if(!this.pointEl.length||!this.pointEl.hasClass(R.itemClass)){return}}var Q=this.pointEl.closest("."+R.rootClass),W=this.dragRootEl.data("nestable-id")!==Q.data("nestable-id");if(!P.dirAx||W||L){if(W&&R.group!==Q.data("nestable-group")){return}N=this.dragDepth-1+this.pointEl.parents(R.listNodeName).length;if(N>R.maxDepth){return}var X=S.pageY<(this.pointEl.offset().top+this.pointEl.height()/2);V=this.placeEl.parent();if(L){T=A(F.createElement(R.listNodeName)).addClass(R.listClass);T.append(this.placeEl);this.pointEl.replaceWith(T)}else{if(X){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}}if(!V.children().length){this.unsetParent(V.parent())}if(!this.dragRootEl.find(R.itemNodeName).length){this.dragRootEl.append('<div class="'+R.emptyClass+'"/>')}if(W){this.dragRootEl=Q;this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};A.fn.nestable=function(L){var N=this,M=this;N.each(function(){var O=A(this).data("nestable");if(!O){A(this).data("nestable",new K(this,L));A(this).data("nestable-id",new Date().getTime())}else{if(typeof L==="string"&&typeof O[L]==="function"){M=O[L]()}}});return M||N}})(window.jQuery||window.Zepto,window,document);
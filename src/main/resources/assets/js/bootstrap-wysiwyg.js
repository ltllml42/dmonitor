(function(B){var A=function(D){var C=B.Deferred(),E=new FileReader();E.onload=function(F){C.resolve(F.target.result)};E.onerror=C.reject;E.onprogress=C.notify;E.readAsDataURL(D);return C.promise()};B.fn.cleanHtml=function(){var C=B(this).html();return C&&C.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")};B.fn.wysiwyg=function(O){var M=this,D,C,Q,N=function(){if(C.activeToolbarClass){B(C.toolbarSelector).find(Q).each(function(){try{var R=B(this).data(C.commandRole);if(document.queryCommandState(R)){B(this).addClass(C.activeToolbarClass)}else{B(this).removeClass(C.activeToolbarClass)}}catch(S){}})}},I=function(R,U){var S=R.split(" "),V=S.shift(),T=S.join(" ")+(U||"");document.execCommand(V,0,T);N()},E=function(R){B.each(R,function(T,S){M.keydown(T,function(U){if(M.attr("contenteditable")&&M.is(":visible")){U.preventDefault();U.stopPropagation();I(S)}}).keyup(T,function(U){if(M.attr("contenteditable")&&M.is(":visible")){U.preventDefault();U.stopPropagation()}})})},F=function(){try{var S=window.getSelection();if(S.getRangeAt&&S.rangeCount){return S.getRangeAt(0)}}catch(R){}},K=function(){D=F()},H=function(){try{var R=window.getSelection();if(D){try{R.removeAllRanges()}catch(T){document.body.createTextRange().select();document.selection.empty()}R.addRange(D)}}catch(S){}},P=function(R){M.focus();B.each(R,function(T,S){if(/^image\//.test(S.type)){B.when(A(S)).done(function(U){I("insertimage",U)}).fail(function(U){C.fileUploadError("file-reader",U)})}else{C.fileUploadError("unsupported-file-type",S.type)}})},L=function(R,S){H();if(document.queryCommandSupported("hiliteColor")){document.execCommand("hiliteColor",0,S||"transparent")}K();R.data(C.selectionMarker,S)},J=function(R,T){R.find(Q).click(function(){H();M.focus();I(B(this).data(T.commandRole));K()});R.find("[data-toggle=dropdown]").click(H);var S=!!window.navigator.msPointerEnabled||(!!document.all&&!!document.addEventListener);R.find("input[type=text][data-"+T.commandRole+"]").on("webkitspeechchange change",function(){var U=this.value;this.value="";H();if(U){M.focus();I(B(this).data(T.commandRole),U)}K()}).on("focus",function(){if(S){return}var U=B(this);if(!U.data(T.selectionMarker)){L(U,T.selectionColor);U.focus()}}).on("blur",function(){if(S){return}var U=B(this);if(U.data(T.selectionMarker)){L(U,false)}});R.find("input[type=file][data-"+T.commandRole+"]").change(function(){H();if(this.type==="file"&&this.files&&this.files.length>0){P(this.files)}K();this.value=""})},G=function(){M.on("dragenter dragover",false).on("drop",function(S){var R=S.originalEvent.dataTransfer;S.stopPropagation();S.preventDefault();if(R&&R.files&&R.files.length>0){P(R.files)}})};C=B.extend({},B.fn.wysiwyg.defaults,O);Q="a[data-"+C.commandRole+"],button[data-"+C.commandRole+"],input[type=button][data-"+C.commandRole+"]";E(C.hotKeys);if(C.dragAndDropImages){G()}J(B(C.toolbarSelector),C);M.attr("contenteditable",true).on("mouseup keyup mouseout",function(){K();N()});B(window).bind("touchend",function(T){var U=(M.is(T.target)||M.has(T.target).length>0),R=F(),S=R&&(R.startContainer===R.endContainer&&R.startOffset===R.endOffset);if(!S||U){K();N()}});return this};B.fn.wysiwyg.defaults={hotKeys:{"ctrl+b meta+b":"bold","ctrl+i meta+i":"italic","ctrl+u meta+u":"underline","ctrl+z meta+z":"undo","ctrl+y meta+y meta+shift+z":"redo","ctrl+l meta+l":"justifyleft","ctrl+r meta+r":"justifyright","ctrl+e meta+e":"justifycenter","ctrl+j meta+j":"justifyfull","shift+tab":"outdent","tab":"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:true,fileUploadError:function(C,D){console.log("File upload error",C,D)}}}(window.jQuery));
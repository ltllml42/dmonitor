(function(M,D){var I="multiple" in document.createElement("INPUT");var A="FileList" in window;var K="FileReader" in window;var F="File" in window;var L=function(R,P){var Q=this;this.settings=M.extend({},M.fn.ace_file_input.defaults,P);this.$element=M(R);this.element=R;this.disabled=false;this.can_reset=true;this.$element.off("change.ace_inner_call").on("change.ace_inner_call",function(U,V){if(Q.disabled){return}if(V===true){return}return C.call(Q)});var T=this.$element.closest("label").css({"display":"block"});var S=T.length==0?"label":"span";this.$element.wrap("<"+S+' class="ace-file-input" />');this.apply_settings();this.reset_input_field()};L.error={"FILE_LOAD_FAILED":1,"IMAGE_LOAD_FAILED":2,"THUMBNAIL_FAILED":3};L.prototype.apply_settings=function(){var Q=this;this.multi=this.$element.attr("multiple")&&I;this.well_style=this.settings.style=="well";if(this.well_style){this.$element.parent().addClass("ace-file-multiple")}else{this.$element.parent().removeClass("ace-file-multiple")}this.$element.parent().find(":not(input[type=file])").remove();this.$element.after('<span class="ace-file-container" data-title="'+this.settings.btn_choose+'"><span class="ace-file-name" data-title="'+this.settings.no_file+'">'+(this.settings.no_icon?'<i class="'+ace.vars["icon"]+this.settings.no_icon+'"></i>':"")+"</span></span>");this.$label=this.$element.next();this.$container=this.$element.closest(".ace-file-input");var P=!!this.settings.icon_remove;if(P){var R=M('<a class="remove" href="#"><i class="'+ace.vars["icon"]+this.settings.icon_remove+'"></i></a>').appendTo(this.$element.parent());R.on(ace.click_event,function(T){T.preventDefault();if(!Q.can_reset){return false}var U=true;if(Q.settings.before_remove){U=Q.settings.before_remove.call(Q.element)}if(!U){return false}var S=Q.reset_input();return false})}if(this.settings.droppable&&A){O.call(this)}};L.prototype.show_file_list=function(W,Z){var V=typeof W==="undefined"?this.$element.data("ace_input_files"):W;if(!V||V.length==0){return}if(this.well_style){this.$label.find(".ace-file-name").remove();if(!this.settings.btn_change){this.$label.addClass("hide-placeholder")}}this.$label.attr("data-title",this.settings.btn_change).addClass("selected");for(var P=0;P<V.length;P++){var R="",Y=false;if(typeof V[P]==="string"){R=V[P]}else{if(F&&V[P] instanceof File){R=M.trim(V[P].name)}else{if(V[P] instanceof Object&&V[P].hasOwnProperty("name")){R=V[P].name;if(V[P].hasOwnProperty("type")){Y=V[P].type}if(!V[P].hasOwnProperty("path")){V[P].path=V[P].name}}else{continue}}}var U=R.lastIndexOf("\\")+1;if(U==0){U=R.lastIndexOf("/")+1}R=R.substr(U);if(Y==false){if((/\.(jpe?g|png|gif|svg|bmp|tiff?)$/i).test(R)){Y="image"}else{if((/\.(mpe?g|flv|mov|avi|swf|mp4|mkv|webm|wmv|3gp)$/i).test(R)){Y="video"}else{if((/\.(mp3|ogg|wav|wma|amr|aac)$/i).test(R)){Y="audio"}else{Y="file"}}}}var S={"file":"fa fa-file","image":"fa fa-picture-o file-image","video":"fa fa-film file-video","audio":"fa fa-music file-audio"};var X=S[Y];if(!this.well_style){this.$label.find(".ace-file-name").attr({"data-title":R}).find(ace.vars[".icon"]).attr("class",ace.vars["icon"]+X)}else{this.$label.append('<span class="ace-file-name" data-title="'+R+'"><i class="'+ace.vars["icon"]+X+'"></i></span>');var T=(Z===true&&F&&V[P] instanceof File)?M.trim(V[P].type):"";var Q=K&&this.settings.thumbnail&&((T.length>0&&T.match("image"))||(T.length==0&&Y=="image"));if(Q){var a=this;M.when(H.call(this,V[P])).fail(function(b){if(a.settings.preview_error){a.settings.preview_error.call(a,R,b.code)}})}}}return true};L.prototype.reset_input=function(){this.reset_input_ui();this.reset_input_field()};L.prototype.reset_input_ui=function(){this.$label.attr({"data-title":this.settings.btn_choose,"class":"ace-file-container"}).find(".ace-file-name:first").attr({"data-title":this.settings.no_file,"class":"ace-file-name"}).find(ace.vars[".icon"]).attr("class",ace.vars["icon"]+this.settings.no_icon).prev("img").remove();if(!this.settings.no_icon){this.$label.find(ace.vars[".icon"]).remove()}this.$label.find(".ace-file-name").not(":first").remove();this.reset_input_data()};L.prototype.reset_input_field=function(){this.$element.wrap("<form>").parent().get(0).reset();this.$element.unwrap()};L.prototype.reset_input_data=function(){if(this.$element.data("ace_input_files")){this.$element.removeData("ace_input_files");this.$element.removeData("ace_input_method")}};L.prototype.enable_reset=function(P){this.can_reset=P};L.prototype.disable=function(){this.disabled=true;this.$element.attr("disabled","disabled").addClass("disabled")};L.prototype.enable=function(){this.disabled=false;this.$element.removeAttr("disabled").removeClass("disabled")};L.prototype.files=function(){return M(this).data("ace_input_files")||null};L.prototype.method=function(){return M(this).data("ace_input_method")||""};L.prototype.update_settings=function(P){this.settings=M.extend({},this.settings,P);this.apply_settings()};L.prototype.loading=function(R){if(R===false){this.$container.find(".ace-file-overlay").remove();this.element.removeAttribute("readonly")}else{var Q=typeof R==="string"?R:'<i class="overlay-content fa fa-spin fa-spinner orange2 fa-2x"></i>';var P=this.$container.find(".ace-file-overlay");if(P.length==0){P=M('<div class="ace-file-overlay"></div>').appendTo(this.$container);P.on("click tap",function(S){S.stopImmediatePropagation();S.preventDefault();return false});this.element.setAttribute("readonly","true")}P.empty().append(Q)}};var O=function(){var P=this;var Q=this.$element.parent();Q.off("dragenter").on("dragenter",function(R){R.preventDefault();R.stopPropagation()}).off("dragover").on("dragover",function(R){R.preventDefault();R.stopPropagation()}).off("drop").on("drop",function(T){T.preventDefault();T.stopPropagation();if(P.disabled){return}var S=T.originalEvent.dataTransfer;var R=S.files;if(!P.multi&&R.length>1){var U=[];U.push(R[0]);R=U}R=J.call(P,R,true);if(R===false){return false}P.$element.data("ace_input_method","drop");P.$element.data("ace_input_files",R);P.show_file_list(R,true);P.$element.triggerHandler("change",[true]);return true})};var C=function(){var P=this.element.files||[this.element.value];P=J.call(this,P,false);if(P===false){return false}this.$element.data("ace_input_method","select");this.$element.data("ace_input_files",P);this.show_file_list(P,true);return true};var H=function(S){var W=this;var P=W.$label.find(".ace-file-name:last");var Q=new M.Deferred;var T=function(Y){P.prepend("<img class='middle' style='display:none;' />");var X=P.find("img:last").get(0);M(X).one("load",function(){U.call(null,X)}).one("error",function(){V.call(null,X)});X.src=Y};var U=function(Z){var X=50;if(W.settings.thumbnail=="large"){X=150}else{if(W.settings.thumbnail=="fit"){X=P.width()}}P.addClass(X>50?"large":"");var Y=G(Z,X);if(Y==null){M(this).remove();Q.reject({code:L.error["THUMBNAIL_FAILED"]});return}var a=Y.w,b=Y.h;if(W.settings.thumbnail=="small"){a=b=X}M(Z).css({"background-image":"url("+Y.src+")",width:a,height:b}).data("thumb",Y.src).attr({src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="}).show();Q.resolve()};var V=function(X){P.find("img").remove();Q.reject({code:L.error["IMAGE_LOAD_FAILED"]})};if(F&&S instanceof File){var R=new FileReader();R.onload=function(X){T(X.target.result)};R.onerror=function(X){Q.reject({code:L.error["FILE_LOAD_FAILED"]})};R.readAsDataURL(S)}else{if(S instanceof Object&&S.hasOwnProperty("path")){T(S.path)}}return Q.promise()};var G=function(Q,U,R){var T=Q.width,X=Q.height;T=T>0?T:M(Q).width();X=X>0?X:M(Q).height();if(T>U||X>U){if(T>X){X=parseInt(U/T*X);T=U}else{T=parseInt(U/X*T);X=U}}var W;try{var V=document.createElement("canvas");V.width=T;V.height=X;var P=V.getContext("2d");P.drawImage(Q,0,0,Q.width,Q.height,0,0,T,X);W=V.toDataURL()}catch(S){W=null}if(!W){return null}if(!(/^data\:image\/(png|jpe?g|gif);base64,[0-9A-Za-z\+\/\=]+$/.test(W))){W=null}if(!W){return null}return{src:W,w:T,h:X}};var J=function(P,Q){var R=B.call(this,P,Q);if(R===-1){this.reset_input();return false}if(!R||R.length==0){if(!this.$element.data("ace_input_files")){this.reset_input()}return false}if(R instanceof Array||(A&&R instanceof FileList)){P=R}R=true;if(this.settings.before_change){R=this.settings.before_change.call(this.element,P,Q)}if(R===-1){this.reset_input();return false}if(!R||R.length==0){if(!this.$element.data("ace_input_files")){this.reset_input()}return false}if(R instanceof Array||(A&&R instanceof FileList)){P=R}return P};var E=function(P){if(!P){return null}if(typeof P==="string"){P=[P]}if(P.length==0){return null}return new RegExp(".(?:"+P.join("|")+")$","i")};var N=function(P){if(!P){return null}if(typeof P==="string"){P=[P]}if(P.length==0){return null}return new RegExp("^(?:"+P.join("|").replace(/\//g,"\\/")+")$","i")};var B=function(W,Z){var P=E(this.settings.allowExt);var c=E(this.settings.denyExt);var a=N(this.settings.allowMime);var b=N(this.settings.denyMime);var Q=this.settings.maxSize||false;if(!(P||c||a||b||Q)){return true}var Y=[];var X={};for(var U=0;U<W.length;U++){var V=W[U];var R=!F?V:V.name;if(P&&!P.test(R)){if(!("ext" in X)){X["ext"]=[]}X["ext"].push(R);continue}else{if(c&&c.test(R)){if(!("ext" in X)){X["ext"]=[]}X["ext"].push(R);continue}}var T;if(!F){Y.push(V);continue}else{if((T=M.trim(V.type)).length>0){if(a&&!a.test(T)){if(!("mime" in X)){X["mime"]=[]}X["mime"].push(R);continue}else{if(b&&b.test(T)){if(!("mime" in X)){X["mime"]=[]}X["mime"].push(R);continue}}}}if(Q&&V.size>Q){if(!("size" in X)){X["size"]=[]}X["size"].push(R);continue}Y.push(V)}if(Y.length==W.length){return W}var d={"ext":0,"mime":0,"size":0};if("ext" in X){d["ext"]=X["ext"].length}if("mime" in X){d["mime"]=X["mime"].length}if("size" in X){d["size"]=X["size"].length}var S;this.$element.trigger(S=new M.Event("file.error.ace"),{"file_count":W.length,"invalid_count":W.length-Y.length,"error_list":X,"error_count":d,"dropped":Z});if(S.isDefaultPrevented()){return -1}return Y};M.fn.aceFileInput=M.fn.ace_file_input=function(S,P){var R;var Q=this.each(function(){var U=M(this);var V=U.data("ace_file_input");var T=typeof S==="object"&&S;if(!V){U.data("ace_file_input",(V=new L(this,T)))}if(typeof S==="string"){R=V[S](P)}});return(R===D)?Q:R};M.fn.aceFileInput.defaults=M.fn.ace_file_input.defaults={style:false,no_file:"No File ...",no_icon:"fa fa-upload",btn_choose:"Choose",btn_change:"Change",icon_remove:"fa fa-times",droppable:false,thumbnail:false,allowExt:null,denyExt:null,allowMime:null,denyMime:null,maxSize:false,before_change:null,before_remove:null,preview_error:null}})(window.jQuery);